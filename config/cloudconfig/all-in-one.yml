#cloud-config

coreos:
  fleet:
    public-ip: {{.IP}}
    metadata: dataPlane=true,routerMesh=true
  update:
    reboot-strategy: "off"
  units:
    - name: fleet.service
      command: start
    - name: update-engine.service
      command: stop
      enable: false
    - name: docker.service
      drop-ins:
      - name: 50-insecure-registry.conf
        content: |
          [Service]
          Environment="DOCKER_OPTS=--insecure-registry 10.0.0.0/8 --insecure-registry 172.16.0.0/12 --insecure-registry 192.168.0.0/16 --insecure-registry 100.64.0.0/10 --registry-mirror=http://france.cafebazaar.ir:5000"
    - name: flanneld.service
      drop-ins:
      - name: 50-network-config.conf
        content: |
          [Service]
          ExecStartPre=/usr/bin/etcdctl mk /coreos.com/network/config '{"Network": "10.244.0.0/16", "SubnetLen": 24, "SubnetMin": "10.244.0.0", "Backend": {"Type": "vxlan"}}'
write_files:
  - path: /etc/motd
    content: "            \e[38;5;240m▄\e[38;5;95m▄\e[39m\e[00m\n          \e[38;5;95m▄\e[48;5;239;38;5;236m▄\e[48;5;233;38;5;238m▄\e[48;5;234;38;5;239m▄\e[48;5;239;38;5;236m▄\e[49;38;5;95m▄\e[39m\e[00m\n         \e[48;5;16;38;5;95m▄\e[48;5;238;38;5;238m▄\e[48;5;238;38;5;232m▄\e[49;38;5;16m▀\e[38;5;16m▀\e[48;5;238;38;5;235m▄\e[48;5;239;38;5;238m▄\e[49;38;5;239m▄\e[39m\e[00m\n   \e[38;5;237m▄\e[38;5;95m▄\e[38;5;95m▄\e[48;5;95;38;5;95m▄\e[48;5;101;38;5;95m▄\e[48;5;95;38;5;95m▄\e[48;5;239;38;5;238m▄\e[48;5;238;38;5;239m▄\e[48;5;95;38;5;239m▄\e[48;5;95;38;5;239m▄\e[38;5;238m▄\e[48;5;95;38;5;239m▄\e[48;5;239;38;5;238m▄\e[48;5;95;38;5;238m▄\e[48;5;95;38;5;95m▄\e[48;5;95;38;5;95m▄\e[48;5;239;38;5;95m▄\e[49;38;5;95m▄\e[38;5;95m▄\e[39m\e[00m\n   \e[48;5;95;38;5;237m▄\e[48;5;95;38;5;237m▄\e[48;5;95;38;5;237m▄\e[48;5;95;38;5;237m▄\e[48;5;238;38;5;239m▄\e[48;5;238;38;5;95m▄\e[48;5;237;38;5;95m▄\e[48;5;237;38;5;137m▄\e[48;5;236;38;5;137m▄\e[48;5;237;38;5;137m▄\e[48;5;236;38;5;137m▄\e[48;5;237;38;5;137m▄\e[48;5;236;38;5;137m▄\e[48;5;239;38;5;238m▄\e[48;5;238;38;5;95m▄\e[48;5;239;38;5;238m▄\e[48;5;95;38;5;237m▄\e[48;5;95;38;5;237m▄\e[48;5;95;38;5;237m▄\e[48;5;95;38;5;238m▄\e[49;39m\e[00m\n   \e[48;5;237;38;5;237m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;136m▄\e[48;5;95;38;5;137m▄\e[48;5;137;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;136;38;5;180m▄\e[48;5;179;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;137;38;5;180m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;95;38;5;95m▄\e[48;5;237;38;5;235m▄\e[49;39m\e[00m\n   \e[48;5;236;38;5;234m▄\e[48;5;137;38;5;95m▄\e[48;5;136;38;5;137m▄\e[48;5;179;38;5;179m▄\e[48;5;136;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;95;38;5;237m▄\e[49;38;5;232m▀\e[39m\e[00m\n   \e[38;5;16m▀\e[48;5;95;38;5;237m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;136;38;5;137m▄\e[48;5;180;38;5;179m▄\e[48;5;180;38;5;180m▄\e[38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;136m▄\e[48;5;136;38;5;136m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;95m▄\e[48;5;236;38;5;234m▄\e[49;39m\e[00m\n    \e[48;5;235;38;5;232m▄\e[48;5;137;38;5;238m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;136;38;5;137m▄\e[48;5;180;38;5;136m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;180;38;5;180m▄\e[48;5;179;38;5;136m▄\e[48;5;136;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;95m▄\e[48;5;237;38;5;235m▄\e[49;39m\e[00m\n     \e[48;5;236;38;5;234m▄\e[48;5;137;38;5;95m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;136;38;5;137m▄\e[48;5;180;38;5;137m▄\e[48;5;180;38;5;136m▄\e[48;5;180;38;5;179m▄\e[48;5;180;38;5;179m▄\e[48;5;180;38;5;136m▄\e[48;5;136;38;5;136m▄\e[48;5;136;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;137m▄\e[48;5;238;38;5;235m▄\e[49;38;5;16m▀\e[39m\e[00m\n      \e[48;5;235;38;5;16m▄\e[48;5;95;38;5;234m▄\e[48;5;137;38;5;236m▄\e[48;5;137;38;5;239m▄\e[48;5;137;38;5;95m▄\e[48;5;137;38;5;95m▄\e[48;5;137;38;5;137m▄\e[48;5;137;38;5;95m▄\e[48;5;137;38;5;95m▄\e[48;5;137;38;5;95m▄\e[48;5;137;38;5;237m▄\e[48;5;137;38;5;235m▄\e[48;5;236;38;5;233m▄\e[48;5;16;38;5;233m▄\e[49;39m\e[00m\n       \e[38;5;16m▀\e[38;5;16m▀\e[48;5;234;38;5;16m▄\e[48;5;234;38;5;16m▄\e[48;5;233;38;5;16m▄\e[48;5;233m▄\e[48;5;233m▄\e[48;5;234;38;5;16m▄\e[48;5;234;38;5;16m▄\e[49;38;5;16m▀\e[38;5;16m▀\e[38;5;232m▀\e[39m\e[00m"
  - path: /etc/profile.d/nse-function.sh
    permissions: '0755'
    content: |
      function nse() {
        docker exec -it $1 bash
      }
  - path: /opt/bin/download-k8s-binary
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      export K8S_VERSION="v1.0.1"
      mkdir -p /opt/bin
      FILE=$1
      if [ ! -f /opt/bin/$FILE ]; then
        curl -sSL -o /opt/bin/$FILE https://storage.googleapis.com/kubernetes-release/release/${K8S_VERSION}/bin/linux/amd64/$FILE
        chmod +x /opt/bin/$FILE
      else
        # we check the version of the binary
        INSTALLED_VERSION=$(/opt/bin/$FILE --version)
        MATCH=$(echo "${INSTALLED_VERSION}" | grep -c "${K8S_VERSION}")
        if [ $MATCH -eq 0 ]; then
          # the version is different
          curl -sSL -o /opt/bin/$FILE https://storage.googleapis.com/kubernetes-release/release/${K8S_VERSION}/bin/linux/amd64/$FILE
          chmod +x /opt/bin/$FILE
        fi
      fi
  - path: /opt/bin/scheduler-policy.json
    content: |
      {
          "kind": "Policy",
          "apiVersion": "v1",
          "predicates": [{"name": "PodFitsPorts"},{"name": "PodFitsResources"},{"name": "NoDiskConflict"},{"name": "MatchNodeSelector"},{"name": "HostName"}],
          "priorities": [{"name": "LeastRequestedPriority","weight": 1},{"name": "BalancedResourceAllocation","weight": 1},{"name": "ServiceSpreadingPriority","weight": 2},{"name": "EqualPriority","weight": 1}]
      }
ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAgEAtPM1uCwJELtmdkT1Cnj/qQXdwhx364O0SH4p7YV5OYFA6fmLQwVdBVIaXBBR10HI9C9OPdgD/YTOjSfn1SY6oJAPP9y57Dnv6nw7zutQeWs7hZvIELKmxQxbiLHrSJUInj4SxVVUQakrB2+wZCPFGz7PXcHyy8o3QjhLCaq/u+QXWAB3RcjBkaeICoan+Qcj0/EWhY77zyQHPZSGV8VBlHOI65Faka7jBppeWsYECThwMnmZ5M8OnLVYaOlecg7EemGVKPt5DoZ2jt/lRCqzhUExsVZB202+G4gxyxz/xM4RRtaP2dkkoMa07Ka2k7bJkd+aHPZXBsd+TK4SiP4/dzAiuj9LVuU0wvTxRzsNMuGUBMKeb12ibSNPzPIpJN8bZAqzsccuakTfbEjIjWRHZ1TpQqLrPlV59AkH2YWAxo6afVL3WM2Qh4upM/bpTpYafivJci1uxfSqrRTdPXIdXmnkNvofq5AqXZShoPKs7lw0V/yz5Tt5egw14/FuI/Gwn1lACylbBr7K3qdJNAEsyIwjXEHM7XBLN8XMuAYMlU8tFvuzfFBquezrtV4CYmYpBHX5xgXRybG4fWYfYZs23v5sgV5kwmvc8CBnqZXK5DigBJClD/KB7XXPf5zL64Czu/ICjFswEWQCyu5wRZE7SHQqB7BjiCAUObDpolhJMV0= remohammadi@gmail.com
